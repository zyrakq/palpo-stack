# üåê Palpo Matrix Server

A modular Docker Compose configuration system for Palpo Matrix homeserver with support for multiple environments and TURN integration capabilities.

## üöÄ Quick Start

### 1. Build Configurations

Use the stackbuilder utility to build all configurations:

```bash
sb build
```

This will create all combinations in the `build/` directory based on [`stackbuilder.toml`](stackbuilder.toml).

### 2. Choose Your Configuration

Navigate to the desired configuration directory:

```bash
# For development with port forwarding
cd build/forwarding/base/

# For production with Let's Encrypt SSL
cd build/letsencrypt/base/

# For production with Step CA SSL
cd build/step-ca/base/

# For internal network deployment
cd build/internal/base/
```

### 3. Configure Environment

Copy and edit the environment file:

```bash
cp .env.example .env
# Edit .env with your values
```

### 4. Deploy

Start the services:

```bash
docker compose up --build -d
```

Access: `http://localhost:8008` (for forwarding mode)

## üìÅ Project Structure

- **`build/`** - Final Docker Compose configurations ready to deploy
- **`components/`** - Source components used to build final configurations
  - `base/` - Base Palpo components
  - `environments/` - Environment components (devcontainer, forwarding, internal, letsencrypt, step-ca)
  - `extensions/` - Extensions (coturn, step-ca-trust)

The `build/` directory contains ready-to-use configurations generated by `sb build` command. The `components/` directory contains the source files that are combined to create these final configurations.

## üîß Available Configurations

### Environments

- **devcontainer**: Development environment with workspace network
- **forwarding**: Development environment with port forwarding (8008:8008, 5432:5432)
- **internal**: Internal network deployment without port forwarding
- **letsencrypt**: Production with Let's Encrypt SSL certificates
- **step-ca**: Production with Step CA SSL certificates

### Extensions

- **coturn**: TURN server integration for voice and video calls
- **step-ca-trust**: Step CA certificate trust integration

## üîê Environment Variables

### Base Configuration

- `COMPOSE_PROJECT_NAME`: Project name for Docker Compose (default: palpo)
- `TZ`: Timezone (default: Europe/Moscow)
- `POSTGRES_DB`: PostgreSQL database name (default: palpo)
- `POSTGRES_USER`: PostgreSQL user (default: palpo)
- `POSTGRES_PASSWORD`: PostgreSQL password (default: changeme)
- `POSTGRES_INITDB_ARGS`: PostgreSQL initialization arguments (default: "--encoding=UTF8 --lc-ctype=C --lc-collate=C")
- `PALPO_IMAGE`: Docker image to use (default: chrislearn/palpo:latest, alternative: ghcr.io/palpo-im/palpo:latest)
- `PALPO_CONFIG`: Path to configuration file (default: /var/palpo/palpo.toml)
- `PALPO_ADDRESS`: Bind address and port (default: 0.0.0.0:8008)
- `PALPO_SERVER_NAME`: Matrix server name (e.g., matrix.example.com)
- `PALPO_TRUSTED_SERVERS`: List of trusted Matrix servers (default: ["matrix.org", "mozilla.org"])
- `PALPO_ALLOW_REGISTRATION`: Allow user registration (default: false)
- `PALPO_FEDERATION_ENABLE`: Enable Matrix federation (default: true)
- `PALPO_PRESENCE_ALLOW_LOCAL`: Allow local presence (default: true)
- `PALPO_MAX_UPLOAD_SIZE`: Maximum upload size in bytes (default: 20000000)
- `PALPO_DB_URL`: PostgreSQL connection URL (auto-generated from POSTGRES_* variables)
- `PALPO_DB_POOL_SIZE`: Database connection pool size (default: 10)

### Forwarding Configuration

- `DB_PORT`: PostgreSQL port for forwarding (default: 5432)
- `PALPO_PORT`: Palpo service port for forwarding (default: 8008)

### Let's Encrypt Configuration

- `VIRTUAL_PORT`: Port for nginx-proxy (default: 8008)
- `VIRTUAL_HOST`: Domain for nginx-proxy (e.g., matrix.example.com)
- `LETSENCRYPT_HOST`: Domain for SSL certificate
- `LETSENCRYPT_EMAIL`: Email for certificate registration

### Step CA Configuration

- `VIRTUAL_PORT`: Port for nginx-proxy (default: 8008)
- `VIRTUAL_HOST`: Domain for nginx-proxy (e.g., matrix.example.local)
- `LETSENCRYPT_HOST`: Domain for SSL certificate
- `LETSENCRYPT_EMAIL`: Email for certificate registration

### Step CA Trust Configuration

- `STEP_CA_TRUST`: Enable Step CA certificate trust (default: true)
- `STEP_CA_TRUST_RESTART`: Restart container when trust configuration changes (default: true)

The step-ca-trust extension automatically configures containers to trust certificates issued by Step CA, enabling secure communication with Step CA-protected services.

### TURN Configuration

- `PALPO_TURN_URIS`: List of TURN server URIs for voice and video calls (e.g., ["turns:example.com?transport=udp", "turns:example.com?transport=tcp"])
- `PALPO_TURN_SHARED_SECRET`: Shared secret for TURN server authentication

The TURN extension enables voice and video calling functionality by configuring TURN servers for NAT traversal and media relay.

## üìû TURN Integration

The TURN extension provides voice and video calling capabilities for Matrix clients by configuring TURN servers for NAT traversal and media relay.

### Using TURN Extension

1. **Build with TURN extension:**

   ```bash
   sb build
   ```

2. **Choose TURN-enabled configuration:**

   ```bash
   # For development with TURN
   cd build/forwarding/coturn/
   
   # For production with Let's Encrypt and TURN
   cd build/letsencrypt/coturn/
   ```

3. **Configure TURN servers:**

   ```bash
   cp .env.example .env
   # Edit .env with your TURN server details
   ```

4. **Example TURN configuration:**

   ```bash
   PALPO_SERVER_NAME=matrix.example.com
   PALPO_TURN_URIS='["turns:turn.example.com?transport=udp", "turns:turn.example.com?transport=tcp"]'
   PALPO_TURN_SHARED_SECRET=your-turn-secret
   ```

5. **Deploy:**

   ```bash
   docker compose up --build -d
   ```

### TURN Server Requirements

For voice and video calls to work properly, you need:

- **TURN Server**: A properly configured TURN server (coturn, eturnal, etc.)
- **Network Access**: TURN server accessible from client networks
- **Authentication**: Shared secret between Palpo and TURN server
- **Protocols**: Support for both UDP and TCP transport
- **Firewall**: Proper firewall configuration for TURN ports

### TURN Server Examples

Popular TURN server implementations:

- **Coturn**: Open-source TURN server with extensive configuration options
- **Eturnal**: Modern Erlang-based TURN server with STUN support
- **Pion TURN**: Go-based TURN server with WebRTC focus

## üóÑÔ∏è PostgreSQL Database

Palpo uses PostgreSQL as its database backend, providing robust and reliable data storage for your Matrix homeserver.

### Database Features

- **ACID Compliance**: Full transactional support for data integrity
- **Performance**: Optimized for concurrent connections with connection pooling
- **Backup**: Standard PostgreSQL backup tools (pg_dump, pg_basebackup)
- **Scalability**: Supports replication and high-availability setups

### Database Management

**Backup:**

```bash
docker exec palpo-db pg_dump -U palpo palpo > backup.sql
```

**Restore:**

```bash
docker exec -i palpo-db psql -U palpo palpo < backup.sql
```

**Access Database:**

```bash
docker exec -it palpo-db psql -U palpo -d palpo
```

## üîí Security

‚ö†Ô∏è **Production Checklist:**

- Configure proper server name and federation settings
- Change default PostgreSQL password
- Set up proper firewall rules
- Regular security updates
- Configure rate limiting
- Set up proper logging
- Validate SSL certificates
- Review federation settings
- Regular database backups

## üÜò Troubleshooting

**Build Issues:**

- Ensure stackbuilder is installed: <https://github.com/zyrakq/stackbuilder>
- Check component file syntax
- Verify all required files exist

**Palpo Issues:**

- Check configuration syntax
- Verify database connectivity: `docker logs palpo-db`
- Review container logs: `docker logs palpo`
- Check network connectivity

**Database Issues:**

- Verify PostgreSQL is running: `docker ps | grep palpo-db`
- Check database logs: `docker logs palpo-db`
- Verify connection string in PALPO_DB_URL
- Check database permissions

**SSL Issues:**

- **Let's Encrypt**: Verify domain DNS and letsencrypt-manager
- **Step CA**: Check step-ca-manager and virtual network config

**Federation Issues:**

- Verify server name configuration
- Check well-known delegation setup
- Validate SSL certificates
- Check firewall and port configuration

**TURN Issues:**

- Verify TURN server accessibility
- Check TURN server configuration
- Validate shared secret
- Test TURN connectivity with tools like `turnutils_uclient`
- Review TURN server logs
- Check firewall rules for TURN ports

## üìù Notes

- The `build/` directory is automatically generated by `sb build` and should not be edited manually
- Environment variables in generated files use `$VARIABLE_NAME` format for proper interpolation
- Each generated configuration includes a complete `docker-compose.yml` and `.env.example`
- User `.env` files are preserved during rebuilds
- Configurations are built using stackbuilder based on [`stackbuilder.toml`](stackbuilder.toml)

## üéØ Palpo Features

The Palpo configuration includes:

- **Modern**: Rust-based Matrix homeserver with modern architecture
- **PostgreSQL**: Reliable and robust database backend
- **Federation**: Full Matrix federation support
- **Registration**: Configurable user registration
- **TURN**: Voice and video calling support with TURN server integration
- **SSL**: Full SSL/TLS support with Let's Encrypt and Step CA
- **Trusted Servers**: Configurable trusted server list
- **Flexible Deployment**: Multiple environment configurations for different use cases

## üåç Deployment Scenarios

### Development Environment

```bash
# Palpo with port forwarding
cd build/forwarding/base/
docker compose up -d

# Palpo with port forwarding and TURN
cd build/forwarding/coturn/
docker compose up -d
```

### Production Environment

```bash
# Palpo with Let's Encrypt SSL
cd build/letsencrypt/base/
docker compose up -d

# Palpo with Let's Encrypt SSL and TURN
cd build/letsencrypt/coturn/
docker compose up -d

# Palpo with Step CA SSL and Step CA trust
cd build/step-ca/step-ca-trust/
docker compose up -d
```

### Internal Network Environment

```bash
# Palpo in internal network
cd build/internal/base/
docker compose up -d

# Palpo in internal network with TURN
cd build/internal/coturn/
docker compose up -d
```

### DevContainer Environment

```bash
# Palpo in DevContainer
cd build/devcontainer/base/
docker compose up -d

# Palpo in DevContainer with TURN
cd build/devcontainer/coturn/
docker compose up -d
```

## ‚öôÔ∏è Advanced Configuration

For detailed configuration options of the Palpo Matrix homeserver, refer to the official Palpo documentation. The configuration file is managed through Docker configs and can be customized by modifying the `palpo-conf` section in the base `docker-compose.yml`.

### Custom Configuration

To add custom configuration options, edit the `configs` section in your deployment's `docker-compose.yml`:

```yaml
configs:
  palpo-conf:
    content: |
      server_name = "${PALPO_SERVER_NAME}"
      # Add your custom configuration here
      # enable_admin_room = true
      # [admin]
      # room_notices = true
      # console_automatic = true
```

## üîó Related Projects

- [Matrix.org](https://matrix.org/) - Open network for secure, decentralized communication
- [Palpo](https://github.com/palpo-matrix-server/palpo) - Modern Matrix homeserver written in Rust
- [Element.io](https://element.io/) - Secure collaboration and messaging
- [Let's Encrypt](https://letsencrypt.org/) - Free SSL certificates
- [Smallstep](https://smallstep.com/) - Private certificate authority
- [PostgreSQL](https://www.postgresql.org/) - Advanced open source database
